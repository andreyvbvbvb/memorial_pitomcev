# Контекст проекта memorial_pitomcev — сводка

Ниже — подробный контекст по проекту (архитектура, ключевые функции, инварианты, текущие настройки, частые проблемы и решения). Документ предназначен для продолжения работы без потери исторического контекста.

## 1) Общая архитектура

**Монорепозиторий pnpm workspaces**.
- `apps/web` — фронтенд на Next.js (App Router).
- `apps/api` — бэкенд на NestJS + Prisma + PostgreSQL.
- `packages` — общие/вспомогательные модули (есть, но пока минимум).
- `docker-compose.yml` — единый compose для деплоя (Timeweb Apps). Сервисов два: `web` и `api`.

**Инфраструктура:**
- Timeweb Apps (Docker Compose) деплой.
- Отдельные managed: Postgres + S3 (Timeweb Cloud Object Storage, совместим с S3).

**Основные URL/порты (локально):**
- Web: `http://localhost:3002`
- API: `http://localhost:3001`

**Production домен:**
- Пример: `https://andreyvbvbvb-memorial-pitomcev-756f.twc1.net` (может меняться, но в .env на проде прописывается как FRONTEND_URL для API и NEXT_PUBLIC_API_URL для web).

**Стили / дизайн:**
- Страница главной обновлена под современный стиль (градиенты, мягкие цвета, карточки). Используются кастомные классы и переменные (в т.ч. для hero-секции).
- Поддерживается видео-фон главного экрана через `NEXT_PUBLIC_HERO_VIDEO_URL`.

## 2) Главные фичи продукта

**Основная идея:**
Создание мемориалов питомцев, которые можно привязать к точке на карте; мемориалы могут быть публичные или приватные.

**Функции:**
1. Регистрация / вход по email+паролю (Google OAuth пока отключен).
2. Создание мемориала (wizard из 5 шагов).
3. 3D-превью мемориала с выбором деталей (поверхность, домик, крыша, стены, элементы), выбор цвета каждой детали.
4. Загрузка фото (до 5 шт, до 10MB каждое), выбор обложки.
5. Глобальная карта мемориалов с кастомными маркерами по виду питомца; кластеризация.
6. Приватность: приватные не отображаются на карте, но точка хранится.
7. Подарки: каталог подарков; установка в слоты на модели; срок действия (1/2/3/6/12 месяцев).
8. Внутренняя валюта (монеты). Пополнение баланса (имитация) и оплата подарков.
9. Профиль пользователя: баланс, логин/почта, редактирование данных.

## 3) Важные инварианты и договоренности

### Мемориал / 3D система
- Есть **две сущности** в 3D сцене: **поверхность (terrain)** и **домик (house)**.
- **Поверхности**: `TERRAIN_summer`, `TERRAIN_winter`, `TERRAIN_autumn`, `TERRAIN_spring` (GLB). В каждой поверхности:
  - `dom_slot` — слот для домика (куда вставляется домик).
  - `gift_slot_1...gift_slot_n` — слоты для подарков.
- **Домики**: `DOM_budka_1`, `DOM_budka_2`, `DOM_aqua_1`, и т.п. У домика свои слоты деталей.
- **Слоты подарков**: имена строго `gift_slot_1...gift_slot_n`.
- **Детали домика**: крыша, стены, украшение над входом, рамки и т.п. У каждой детали свой слот.
- **Подарки**: могут устанавливаться в slоты только при покупке (не в редакторе по умолчанию).
- **Anchors / маяки**: в 3D моделях используются пустые объекты (anchors) с заданными именами, к которым привязываются детали/подарки.

### Маркеры карты
- Пользователь выбирает вид питомца, автоматически подставляется тип маркера.
- В редакторе выбора маркера показываются картинки (без подписей), в один ряд.
- Размер маркеров на карте увеличен на ~20% относительно дефолта, сделаны мягкие иконки.

### Фото
- До 5 фото на мемориал, размер до 10 МБ.
- Фото показываются в мини-галерее, на странице мемориала есть lightbox (просмотр больших).

### Подарки
- Подарки покупаются на время (1/2/3/6/12 месяцев), после истечения скрываются.
- Слот занят — кнопки не показываются (нельзя выбрать занятый слот).
- Номера слотов (1,2,3...) сейчас отображаются на кнопках.
- В 3D‑превью на странице мемориала по умолчанию не показывается «предложенный» подарок до выбора подарка/слота.

### Профиль
- Убираем owner_id из UI.
- `/profile` доступен только авторизованным (неавторизованных редирект на /auth).
- Логин: только латиница (a-z), цифры, `_` (без точки).
- Логин и email уникальные в БД.

## 4) Структура страниц (web)

### `/` (Главная)
- Hero блок с текстом «Сохраняйте тёплую память о ваших питомцах», 2 кнопки: Создать мемориал / Смотреть мемориалы.
- Header с кнопкой входа, после входа — меню «книжки» с навигацией (профиль, мои питомцы, карта, о проекте, выход).
- Video фон: через `NEXT_PUBLIC_HERO_VIDEO_URL`.
- Ниже — блок «Как это работает» и карточки/описание проекта.

### `/create`
- Пошаговый мастер (5 шагов):
  1) Основные данные (имя, вид, даты рождения/ухода). Даты обязательны.
  2) Маркер и точка на карте.
  3) 3D редактор.
  4) Фото + эпитафия + история питомца.
  5) Проверка (без данных про маркер/детали — только текстовые данные и фото, 3D превью увеличено).

- В шаге 3: слева 3D превью, справа настройки. По ширине: 60/40 или 65/35, с отступами слева и справа.
- На мобиле: по умолчанию десктопный вид, есть кнопка переключения на мобильный. Для мобильного режима кнопки «Назад/Далее» фиксированы сверху, превью уменьшено на 10%.

### `/map`
- Карта Google Maps + справа список мемориалов; ширина колонок: карта ~55% (min 400px), список ~25% (min 360px), общий контейнер на всю ширину.
- Фильтры по виду питомца и имени (вверху, ширина равна карте+списку).
- Список справа фильтруется по видимой области карты и по фильтрам; счетчик показывает текущее количество.
- Высота списка равна высоте карты; при большом количестве — скролл внутри списка.
- Кластеризация маркеров включена; при hover карточки справа маркер подпрыгивает (bounce).
- Заголовки выровнены по центру, убраны подписи «Карта»/«Google Maps» над картой.

### `/pets/[id]` (страница мемориала)
- 3D превью увеличено, ширина страницы увеличена на ~10%.
- Раздел «Подарки» под 3D, отображение слотов, баланс пользователя, кнопка пополнения.
- «От:» — в списке подарков отображаются питомцы владельца (кликабельные).
- Наведение на подарок в 3D показывает tooltip; по умолчанию превью-подарка не показывается, пока пользователь не выберет подарок или слот.
- Tooltip в 3D: компактный, авто‑ширина (min/max), уменьшенный шрифт.

### `/my-pets`
- Список мемориалов пользователя доступен только авторизованным (иначе редирект на /auth).
- Убраны ownerId‑фильтр и кнопки «Создать мемориал» / «Профиль».
- Карточки показывают превью‑фото (previewPhotoId или первое фото), текст справа.
- Есть 4 режима отображения карточек (переключатель 1–4), включая masonry‑сетки.

### `/profile`
- Баланс, данные пользователя, редактирование логина/почты/пароля.

## 5) Бэкенд: основные модули

- `AuthModule` — регистрация, вход, logout, `me`, forgot password (через email).
- `UsersModule` — данные пользователя, логин, email, баланс.
- `PetsModule` — CRUD мемориалов, фото, превью-фото.
- `MapModule` — выдача маркеров (публичные мемориалы).
- `GiftsModule` — каталог подарков.
- `WalletModule` — пополнение монет.
- `StorageModule` — загрузка в S3.
- `MailModule` — отправка писем (Yandex SMTP).
- `PrismaModule` — PrismaService.

### Prisma
- Prisma v7.3.0. Используется `prisma.config.ts` (Prisma 7 требует вынести datasource URL из schema).
- Миграции есть (init, coins, species, gifts, login).
- Проблема: нужно следить, чтобы Prisma client генерировался при билде и был доступен в runtime контейнере.

## 6) Docker / деплой

**Docker Compose**
- Сервисы `web` и `api`.
- `web` запускается на 3002, `api` — 3001.
- В compose используются env vars через `KEY=${KEY}`.

**Dockerfile API**
- Multi-stage build: deps → build → runner.
- В build: `prisma:generate` и `build`.
- В runner копируем `node_modules`, `apps/api/dist`, `apps/api/prisma`, `prisma.config.ts`.
- Критично: `.prisma` должен быть доступен в runtime, иначе ошибка `Cannot find module '.prisma/client/default'`.

**Dockerfile Web**
- Multi-stage build: deps → build → runner.
- `next build` в build.

**Timeweb Apps**
- Важно: переменные окружения указываются в панели Timeweb, а в docker-compose передаются через `${VAR}`.
- `DATABASE_URL` должен быть доступен и для билда (prisma generate), и для runtime.
- Рабочая схема: env vars в Timeweb (глобальные или на проект).

**Частые проблемы деплоя:**
- `Cannot find module '.prisma/client/default'` → в runtime нет сгенерированного prisma client; исправлено копированием `.prisma` или генерацией в build.
- `datasource.url required` → неправильно сконфигурирован prisma config (Prisma 7).
- `no space left on device` → на Timeweb кончилась память (исправляли вручную).
- Ошибки TS из-за JSX IntrinsicElements (three/fiber) → добавлялись типы в `apps/web/types/react-three-fiber.d.ts`.

## 7) Настройки S3

**Переменные окружения:**
- `S3_ENDPOINT` (например `https://s3.twcstorage.ru`)
- `S3_REGION` (`ru-1`)
- `S3_BUCKET`
- `S3_ACCESS_KEY`
- `S3_SECRET_KEY`

**Важно:** endpoint должен быть с протоколом `https://`, иначе `ERR_INVALID_URL`.

## 8) UI / дизайн система

- Используется светлая палитра (голубые/нейтральные).
- Hero: градиент + видео.
- Кнопки не должны растягиваться по ширине.
- Элементы центрируются по сетке `max-w-6xl` (или близко).
- Анимация появления hero элементов (stagger) есть.

## 9) Текущие нерешённые задачи (на момент последнего контекста)

1. **/map**: карта «самосмещается» после перемещения — вероятно из-за `fitBounds` или автозума/центровки.
2. **/pets/[id]**: увеличить высоту 3D превью на 20% (нужно проверить, как сделано на /create).
3. **/pets/[id]**: улучшить вид и прозрачность маркеров (меньше и круглее).

## 10) Локальные фикс-паттерны (частые решения)

- **MapClient.tsx**:
  - Должно быть `center`/`zoom`, не `defaultCenter`/`defaultZoom`, иначе TS ошибка.
  - Фильтровать список по `visibleMarkers` (определяются через `map.getBounds()` на `onIdle`) + учитывать локальные фильтры (вид/имя).
  - Избегать `fitBounds` после первого загрузки (если мешает перетаскиванию).
  - Высота карты и списка синхронизирована через общую константу (mapHeight).

- **react-three-fiber** типы:
  - В `apps/web/types/react-three-fiber.d.ts` необходимо добавить `primitive`, `group`, `ambientLight`, `directionalLight`, `color` (если используется) — иначе TS не собирается.
  - В `MemorialPreview` используем `const Group = "group" as React.ComponentType<any>` и рендерим `<Group>` вместо `<group>`, чтобы избежать TS ошибки в билде.

- **S3**:
  - Убедиться, что URL endpoints корректный (https).

- **Prisma**:
  - Prisma client должен быть доступен в runtime контейнере. Либо генерация в build + копирование, либо postinstall.

## 11) Список основных env vars

### API
- `DATABASE_URL`
- `JWT_SECRET`
- `JWT_EXPIRES`
- `FRONTEND_URL`
- `SMTP_HOST`, `SMTP_PORT`, `SMTP_SECURE`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM`
- `S3_ENDPOINT`, `S3_REGION`, `S3_BUCKET`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`

### WEB
- `NEXT_PUBLIC_API_URL`
- `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY`
- `NEXT_PUBLIC_HERO_VIDEO_URL`

## 12) История сложностей / решений (кратко)

- **Docker compose**: Timeweb не поддерживает volumes — убрали.
- **Prisma v7**: datasource URL вынесен в prisma.config.ts.
- **TS ошибки**: из-за JSX IntrinsicElements — решено добавлением типов.
- **Map**: добавлены фильтры по виду/имени, фильтрация списка по bounds, bounce маркера при hover карточки, высота списка = высоте карты.
 - **My-pets**: убран ownerId‑фильтр, доступ только авторизованным, добавлены 4 дизайна карточек.
 - **Pets API**: `/pets` возвращает `photos` (с sortOrder) и `marker` для превью‑фото.

## 13) Где что находится

- Главная страница UI: `apps/web/app/page.tsx` + стили.
- Карта: `apps/web/app/map/MapClient.tsx`.
- Создание мемориала: `apps/web/app/create/CreateMemorialClient.tsx`.
- Мемориал: `apps/web/app/pets/[id]/PetClient.tsx`.
- Профиль: `apps/web/app/profile`.
- Auth: `apps/web/app/auth`.
- Prisma: `apps/api/prisma/schema.prisma` + `apps/api/prisma.config.ts`.
- S3: `apps/api/src/storage`.

---

Если нужно, могу добавить краткий чеклист для следующего цикла работ (fix map + UI). Можно также вынести этот документ в README/DEV_NOTES.
