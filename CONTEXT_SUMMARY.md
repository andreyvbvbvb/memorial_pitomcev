# Контекст проекта memorial_pitomcev — актуальная сводка

Документ для быстрого вхождения в проект и продолжения работ без потери контекста.

## 1) Архитектура и инфраструктура
- **Монорепо pnpm workspaces**.
  - `apps/web` — Next.js (App Router).
  - `apps/api` — NestJS + Prisma + PostgreSQL.
  - `packages` — общие модули (минимально).
- **Деплой**: Timeweb Apps (Docker Compose). Сервисы: `web`, `api`.
- **Локальные порты**: Web `3002`, API `3001`.
- **S3**: Timeweb Object Storage (S3‑compatible).

## 2) Главные фичи
- Мемориалы питомцев (public/private), точка на карте.
- 5‑шаговый мастер создания мемориала.
- 3D‑превью с выбором деталей и цветами.
- Глобальная карта с фильтрами и кастомными маркерами.
- Подарки: покупка, срок (1/2/3/6/12), слоты на 3D.
- Внутренняя валюта и пополнение.
- Профиль пользователя.

## 3) Ключевые изменения UI
- **Главная**: вместо видео — полноэкранная 3D‑сцена (модель `main_page.glb`) с плавным вращением.
- **Общий стиль**: фон `#fbf7f5`, текст `#6b6a69`.
- **Header**:
  - высота уменьшена ~в 2 раза, фон полупрозрачный (`bg-white/60`).
  - в меню‑«книжке» — поп‑ап пополнения баланса (RUB/USD, выбор тарифа, кнопка “Продолжить” → `/payment`), показывает текущий баланс.
- **/map**:
  - Полноэкранный контейнер без скролла; хедер занимает ~5% высоты (max 56px).
  - Блок фильтров слева; в map/3D режимах одинаковая ширина/стили.
  - В **map**‑режиме список мемориалов справа (высота фиксирована, скролл внутри).
  - В **3D**‑режиме — карусель мемориалов на одной сцене (круг), центральный мемориал выдвигается и подсвечивается; переходы плавные, можно листать кнопками/стрелками клавиатуры и кликом по зонам слева/справа.
- **/my-pets**:
  - Доступ только авторизованным (иначе /auth).
  - Оставлены только **4‑й** (masonry) и **5‑й** (3D) режимы.
  - **5‑й режим**: 3D‑превью на весь экран, под хедером, как фон; UI поверх.
- **/pets/[id]** (мемориал):
  - Выбор подарка/срока/слота находится над 3D‑превью.
  - По клику на слот показывается примерка; повторный клик снимает примерку.
  - Tooltip по подаркам компактный, уменьшенный шрифт.
  - Блок дарения скрывается для неавторизованных.

## 4) 3D система
- **Terrain** и **House** — отдельные модели.
- В terrain обязателен `dom_slot`.
- **Слоты подарков**: `gift_{type}_{index}` (например, `gift_ground_1`, `gift_floor_2`).
  - Legacy `gift_slot_1..` читается как тип `ground`.
  - Дефолтный список слотов — **10**, но рендерятся только реально найденные anchors в GLB.
- **Заглушка слота**: `/models/gifts/slot_placeholder.glb` (подставляется в каждый доступный slot).
- **Размер подарков**:
  - `star` поддерживает `s/m/l` (множители ~0.35 / 0.5 / 0.7 от базового).
  - `candle_1..8` ширина ~0.3м, `candle_9..12` ширина ~1м.
  - `flower_*` ширина ~0.6м.

### Детали домика (слоты)
Слоты берутся **автоматически из GLB домика** по именам узлов:
`roof_slot`, `wall_slot`, `sign_slot`, `frame_left_slot`, `frame_right_slot`, `mat_slot`, `bowl_food_slot`, `bowl_water_slot`.
Если слот отсутствует в модели — соответствующий выбор в редакторе не показывается.

## 5) Управление моделями (автогенерация)
- Скрипт: `apps/web/scripts/generate-models.mjs`.
- Генерирует:
  - `apps/web/lib/memorial-models.generated.ts`
  - `apps/web/lib/memorial-options.generated.ts`
  - `apps/web/lib/memorial-slots.generated.ts` (слоты домиков из GLB)
  - `apps/web/lib/markers.generated.ts`
  - `apps/web/lib/gifts.generated.ts`
  - `apps/api/src/gifts/gifts.generated.ts`
- Запускается автоматически в `predev` и `prebuild`.
- Достаточно **положить .glb** в нужную папку, списки обновятся автоматически.

### Папки моделей
- Terrains: `apps/web/public/models/terrains` (`TERRAIN_*.glb`)
- Houses: `apps/web/public/models/houses` (`DOM_*.glb`)
- Parts: `apps/web/public/models/parts/*` (`roof_*.glb`, `wall_*.glb`, `bowl_food_*.glb`, `bowl_water_*.glb`, etc.)
- Gifts: `apps/web/public/models/gifts/{type}` (`{type}_*.glb`)

### Иконки подарков
- `apps/web/public/gifts_icons/{code}.png` (используются в списке подарков).
- В UI список подарков сортируется по категориям (типу) по алфавиту.

## 6) Превью‑картинки деталей (Create)
- Путь формата: `/memorial/options/{category}/{id}.png`.
- Пример: `bowl_food_3` → `apps/web/public/memorial/options/bowl-food/bowl_food_3.png`.

## 7) Маркеры карты
- **Маркеры**: `apps/web/public/markers/*.png`.
- **Иконки выбора**: `apps/web/public/markers_icons/*_icon.png`.
- В UI выбора маркера сначала показываются варианты выбранного вида питомца, ниже — остальные.
- На карте показываются PNG из `markers`, **а на кнопках выбора** — из `markers_icons`.
- В `markers.generated.ts` сохраняются `url` (для карты) и `iconUrl` (для выбора).
- **Размеры**:
  - Маркеры уменьшены до **128 px** по ширине.
  - Иконки выбора — **100 px** по ширине.

## 8) Создание мемориала (/create)
- 5 шагов.
- Шаг 3 (3D):
  - контейнер шире, колонка превью увеличена, колонка деталей уменьшена;
  - высота превью/колонки уменьшена ~на 15%;
  - превью с “мягкими” краями (soft edges) + уменьшенный gap.
  - список деталей домика строится только по слотам из модели; без “Загружаем детали домика…”.
- Шаг 4: фото без сильного кропа, галерея.
- Шаг 5: проверка — без вида питомца/публичности; 3D превью уменьшено.
 - **Оплата мемориала** под 3D‑превью: 1/2/5 лет + бессрочно (100/200/500/1500 монет).
   Кнопка “Опубликовать мемориал” показывает выбранную цену; при нехватке средств открывается поп‑ап пополнения.

## 9) Профиль и Auth
- Auth: центрированный блок, вход по Enter, минимум текста.
- Header: после входа меню‑«книжка» с балансом; кнопка `+` (создать мемориал) с hover‑анимацией и подсказкой.

## 10) Важные env
### API
`DATABASE_URL`, `JWT_SECRET`, `FRONTEND_URL`, `S3_*`, `SMTP_*`

### WEB
`NEXT_PUBLIC_API_URL`, `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY`

## 11) Частые проблемы
- Prisma v7: datasource в `prisma.config.ts`.
- Timeweb: env нужен и для build, и для runtime.
- R3F JSX: используем `const Group = "group" as React.ComponentType<any>` и т.п.

---
Если нужно, могу дополнить этот документ под конкретные задачи.
