services:
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
        NEXT_PUBLIC_HERO_VIDEO_URL: ${NEXT_PUBLIC_HERO_VIDEO_URL}
    environment:
      - PORT=3002
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_HERO_VIDEO_URL=${NEXT_PUBLIC_HERO_VIDEO_URL}
      - INTERNAL_API_URL=${INTERNAL_API_URL}
    ports:
      - "3002:3002"
    depends_on:
      - api

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    environment:
      - PORT=3001
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES=${JWT_EXPIRES}
      - FRONTEND_URL=${FRONTEND_URL}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM=${SMTP_FROM}
      - SMTP_SECURE=${SMTP_SECURE}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_PUBLIC_BASE_URL=${S3_PUBLIC_BASE_URL}
    ports:
      - "3001:3001"
    command: sh -c "node /app/apps/api/node_modules/prisma/build/index.js generate && node -e \"const fs=require('fs');const path=require('path');const clientDir=path.dirname(require.resolve('@prisma/client'));const source=path.join(clientDir,'..','..','.prisma');const target=path.join(clientDir,'.prisma');fs.rmSync(target,{recursive:true,force:true});fs.cpSync(source,target,{recursive:true});\" && node /app/apps/api/node_modules/prisma/build/index.js migrate deploy && node dist/main.js"
